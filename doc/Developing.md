# Developing wdlTools

## Setting up your development environment

* Install JDK 8
    * On mac with [homebrew]() installed:
    ```
    $ brew tap AdoptOpenJDK/openjdk
    $ brew cask install adoptopenjdk8
    # Use java_home to find the location of JAVA_HOME to set
    $ /usr/libexec/java_home -V
    $ export JAVA_HOME=/Library/Java/...
    ```
    * On Linux (assuming Ubuntu 16.04)
    ```
    $ sudo apt install openjdk-8-jre-headless
    ```
    * Scala will compile with JDK 11, but the JDK on DNAnexus worker instances is JDK 8 and will not be able to run a JAR file with classes compiled by a later version of Java
* Install [sbt](https://www.scala-sbt.org/), which also installs Scala. Sbt is a make-like utility that works with the ```scala``` language.
    * On MacOS: `brew install sbt`
    * On Linux:
    ```
    $ wget www.scala-lang.org/files/archive/scala-2.12.1.deb
    $ sudo dpkg -i scala-2.12.1.deb
    $ echo "deb https://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
    $ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
    $ sudo apt-get update
    $ sudo apt-get install sbt
    ```
    * Running sbt for the first time takes several minutes, because it downloads all required packages.
* We also recommend to install [Metals](https://scalameta.org/metals/), which enables better integration with your IDE
    * For VSCode, install the "Scala (Metals)" and "Scala Syntax (official)" plugins
* You will need to create a GitHub personal access token (this is required by the sbt-github-packages plugin).
    * In GitHub settings, go to "Developer settings > Personal access token" and create a new token with "write:packages" and "read:packages" scopes only.
    * Export the `GITHUB_TOKEN` environment variable with this token as the value. For example, in your `.profile`:
    ```bash
    export GITHUB_TOKEN=<your personal access token>
    ```
    * On macOS, you may also want to add this token into your global environment so it is visible to your IDE:
    ```bash
    launchctl setenv GITHUB_TOKEN $GITHUB_TOKEN
    ```

## Getting the source code

* Clone or fork the [wdlTools repository](https://github.com/dnanexus-rnd/wdlTools) (depending on whether you have commit permissions)
* Checkout an existing branch or create a new branch (e.g. feat/42-my-feature)
* Add pre-commit hooks:
    * Create/edit a file .git/hooks/pre-commit
    * Add the following lines
    ```bash
    #!/bin/bash
    check=$(sbt scalafmtCheckAll)
    if [[ "$?" -ne "0" ]]; then
      echo "Reformatting; please commit again"
      sbt scalafmtAll
      exit $check
    fi
    ```
    * Make the file executable (e.g. `chmod +x .git/hooks/pre-commit`)
    * This hook runs the code formatter before committing code. You can run this command manually, but it is easiest just to have it run automatically.

## Generating the parsers

wdlTools depends on parsers for each WDL version, which are generated by ANTLR4. The first time you build wdlTools, as well as any time you change the parser grammar, you need to (re)generate the parser classes. To do so, run the following command from the `wdlTools` root directory:

```
$ make
```

## Using sbt

sbt is the build system for Scala (similar to a Makefile). The following are the main commands you will use while developing.

### Compiling the code

Scala (like Java) is a compiled language. To compile, run:

```
$ sbt compile
```

If there are errors in your code, the compiler will fail with (hopefully useful) error messages.

### Running unit tests

You should always run the unit tests after every successful compile. Generally, you want to run `sbt testQuick`, which only runs the tests that failed previously, as well as the tests for any code you've modified since the last time you ran the tests. However, the first time you checkout the code (to make sure your development environment is set up correctly) and then right before you push any changes to the repository, you should run the full test suite using `sbt test`.

### Generating a stand-alone JAR file

```
$ sbt assembly
$ java -jar target/scala-2.13/wdlTools.jar ...
```

### Other sbt tips

#### Cache

sbt keeps the cache of downloaded jar files in `${HOME}/.ivy2/cache`. For example, the WDL jar files are under `${HOME}/.ivy2/cache/org.broadinstitute`. In case of problems with cached jars, you can remove this directory recursively. This will make WDL download all dependencies (again).

## Adding new code

If you want to make a change to wdlTools, do the following:

1. Checkout the `develop` branch.
2. Create a new branch with your changes. Name it something meaningful, like `APPS-123-download-bug`.
3. If the current snapshot version matches the release version, increment the snapshot version.
    - For example, if the current release is `1.0.0` and the current snapshot version is `1.0.0-SNAPSHOT`, increment the snapshot version to `1.0.1-SNAPSHOT`.
3. Make your changes.
4. Always write unit tests for any new code you add, and update tests for any code you modify.
    * Unit tests should assert, and not print to the console
    * WDL test files belong in the top directory `test`
5. Test locally using `sbt test`.
6. Update the release notes under the top-most header (which should be "in develop").
7. If the current snapshot version only differs from the release version by a patch, and you added any new functionality (vs just fixing a bug), increment the minor version instead.
    - For example, when you first created the branch you set the version to `1.0.1-SNAPSHOT`, but then you realized you needed to add a new function to the public API, change the version to `1.1.0-SNAPSHOT`.
8. When you are done, create a pull request against the `develop` branch.

### Style guidelines

* We use [scalafmt style](https://scalameta.org/scalafmt/) with a few modifications. You don't need to worry so much about code style since you will use the automatic formatter on your code before it is committed.
* Readability is more important than efficiency or concision - write more/slower code if it makes the code more readable.
* Avoid using more complex features, e.g. reflection.

### Building a local version for testing

- Set version name in `<project>/src/main/resources/application.conf` to `X.Y.Z-SNAPSHOT`.
- Run `sbt publishLocal`, which will [publish to your Ivy local file repository](https://www.scala-sbt.org/1.x/docs/Publishing.html).
- In any downstream project that will depend on the changes you are making, set the dependency version in `build.sbt` to `X.Y.Z-SNAPSHOT`.

### Merging the PR

When a PR is merged into `develop`, SNAPSHOT packages are automatically published to GitHub packages. When you push to `develop` (including merging a PR), you should announce that you are doing so (e.g. via GChat) for two reasons:

* Publishing a new snapshot requires deleting the existing one. If someone is trying to fetch the snapshot from the repository at the time when the snapshot workflow is running, they will get a "package not found" error.
* Although unlikely, it is possible that if two people merge into `develop` at around the same time, the older SNAPSHOT will overwrite the newer one.

## Releasing

### Sonatype Nexus publishing setup

- Have `dnanexus`'s password for [Sonatype Nexus repository manager](https://oss.sonatype.org/#stagingRepositories).
- Install gnupg `brew install gnupg`.
- Generate a key `gpg --quick-gen-key <your email> rsa2048`. Remember the passphrase.
- Get the key's identifier.

```
% gpg --list-keys

pub   rsa2048 2021-09-09 [SC] [expires: 2023-09-09]
      <key identifier is this string>
uid           [ultimate] <your email>
```

- Distribute the key `gpg --keyserver keyserver.ubuntu.com --send-keys <key identifier>`.
- Export secret key for sbt plugin `gpg --armor --export-secret-key > ~/.sbt/gpg/secring.asc`. You will need to enter the passphrase.
- Add the following to `~/.sbt/1.0/plugins/gpg.sbt`.

```
credentials += Credentials(
  "GnuPG Key ID",
  "gpg",
  "<key identifer>", // key identifier
  "ignored" // this field is ignored; passwords are supplied by pinentry
)
```

- Add the following to `~/.sbt/1.0/sonatype.sbt`.

```
credentials += Credentials(Path.userHome / ".sbt" / "sonatype_credentials")
```

- Add the following to `~/.sbt/sonatype_credentials`.

```
realm=Sonatype Nexus Repository Manager
host=oss.sonatype.org
user=dnanexus
password=<dnanexus's password>
```

### Beginning the release

1. Checkout the develop branch (either HEAD or the specific commit you want to release)
2. Create a release branch named with the version number, e.g. `release-2.4.2`
3. Update the version numbers in application.conf files (remove "-SNAPSHOT")
4. Update the release notes
    - Change the top header from "in develop" to "<version> (<date>)"

### Releasing to GitHub

1. Push the release branch to GitHub.
2. Run the release action.
3. Go to the "Releases" page on GitHub and publish the draft release.

### Releasing to Maven

Note: this process is currently coordinated by John Didion - please request from him a release of the updated library(ies).

1. From the release branch, run `sbt publishSigned -DreleaseTarget=sonatype`. You will need to have completed the "Sonatype Nexus publishing setup" instructions above.
2. Go to [Sonatype Nexus repository manager](https://oss.sonatype.org/#stagingRepositories), log in as `dnanexus`, and go to "Staging Repositories".
3. Check the repository to release; there should only be one, but if there are more check the contents to find yours.
4. Click the "Close" button. After a few minutes, hit "Refresh". The "Release" button should become un-grayed. If not, wait a few more minutes and referesh again.
5. Click the "Release" button.

### Completing the release

If you encounter any additional issues while creating the release, you will need to make the fixes in `develop` and then merge them into the release branch.

To complete the release, open a PR to merge the release branch into main. The easiest way to do this is to run `git merge main -X ours` from the release branch, commit, and push. Then set the base to `main` on the PR and merge the PR. You can then delete the release branch.

Unfortunately, the tags that are created on the release branch are not merged into `main` when merging the PR. Thus, after merging the PR, you must manually tag the `main` branch with the release, e.g.

```
$ git tag wdlTools-0.12.10 -am "release wdlTools 0.12.10"
$ git push origin wdlTools-0.12.10
```

## wdlTools CLI

### Adding a new command

1. Create a new class in a file with the same name as the command:
    ```scala
    package wdlTools.cli
   
    import scala.language.reflectiveCalls
    
    case class MyCommand(conf: WdlToolsConf) extends Command {
      override def apply(): Unit = {
          ...
      }
    }
    ```
2. In `package`, add a new subcommand definition:
    ```scala
    val mycommand = new WdlToolsSubcommand("mycommand", "description") {
        // add options, for example
        val outputDir: ScallopOption[Path] = opt[Path](
            descr = "Directory in which to output files",
            short = 'O'
        )
    }
    ```
3. In `Main`, add your command to the pattern matcher:
    ```scala
    conf.subcommand match {
       case None => conf.printHelp()
       case Some(subcommand) =>
         val command: Command = subcommand match {
           case conf.mycommand => MyCommand(conf)
           ...
           case other          => throw new Exception(s"Unrecognized command $other")
         }
         command.apply()
    }
    ```
